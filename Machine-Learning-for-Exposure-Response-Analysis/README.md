## Machine Learning for Exposure-Response Analysis:

Methodological Considerations and Confirmation of Their
Importance via Computational Experimentations

Rashed Harun, Eric Yang, Nastya Kassir, Wenhui Zhang, James Lu

### 요약

- 약물 용량을 결정하는 **노출-반응(E-R) 분석**에 대한 기계 학습(ML) 활용 방법을 제시
- 데이터에서 편향을 없애고 **정확한 인과 관계**를 도출하기 위한 **좋은 실천 방법**들을 제시함
  1. **인과 다이어그램**을 사용해 모델에서 어떤 변수를 고려해야 할지 신중하게 결정
  2. **모델 훈련 데이터**와 **추론 데이터**를 엄격하게 분리해 편향을 피함
  3. **하이퍼파라미터 튜닝**으로 모델의 신뢰성 향상
  4. **부트스트랩 샘플링**을 사용해 **추론**의 신뢰 구간을 추정
- 연구는 시뮬레이션된 데이터셋을 사용하여 이 방법들이 **비선형적**이고 **비단조적**인 E-R 관계에서도 효과적임을 증명함

### 사용되는 기법

- **XGBoost**
  - **이진 분류** 알고리즘
  - **유도 모델**, **유지 모델**, **유도에서 유지로의 모델**을 각각 생성하여 **노출-반응 관계**를 분석
  - 결정 트리
- **SHAP 분석**
  - **기계 학습 모델**의 예측에 대한 **설명 가능성**을 높이기 위해 사용되는 기법
  - **협력적 게임 이론**에 기반하여 변수들이 모델 예측에 미치는 **기여도**를 **정량화**
  - 각 변수의 **기여도를 측정**하여 예측 결과가 어떻게 이루어졌는지 이해
- **XGBoost는 예측 모델링을 담당하고, SHAP 분석은 그 예측을 설명 가능하게 만들어줌**

---

### 연구에서 사용하는 주요 변수들의 정의

- **유도 단계 (Induction stage, I)**
  - **hI**: 건강 상태 (health status)
  - **xI1, xI2, xI3, xI4**: 공변량 (covariates), 즉 약물 효과에 영향을 미칠 수 있는 변수들
  - **rI**: 치료 무작위화 변수 (treatment randomization), **rI = 1**이면 활성 치료군, **rI = 0**이면 위약군
  - **cI**: 유도 단계 시작 시점에서의 교란 변수 (confounding variable)
  - **tI**: 유도 단계에서의 약물 노출 (drug exposure)
- **유지 단계 (Maintenance stage, M)**
  - **hM**: 건강 상태
  - **xM1, xM2, xM3**: 공변량
  - **rM**: 치료 무작위화 변수
  - **cM**: 유지 단계에서의 교란 변수
  - **tM**: 유지 단계에서의 약물 노출
- **y1, y2**: 이 변수들은 유도 단계와 유지 단계의 **이진 결과 변수**

### 서론

- 병 -( 유도효과, y1 )→ 나아짐 -( 유지효과, y2 )→ 지속
- ML의 문제점: 과적합! (AUROC = 1.0)
  - AUROC: 모델이 양성/음성 얼마나 잘 구분하냐
    - AUROC = 0.5: 그냥 무작위 예측이랑 동일
    - AUROC < 0.5: 모델이 오히려 반대로 예측함
    - 즉, 0.5 < AUROC < 1.0이 적합
- 해결책 1: **k겹 교차 검증**
  - 데이터를 **k번** 나누어 훈련 데이터와 검증 데이터를 **교차적으로** 사용하여 모델을 평가
  - 첫 번째 반복에서 첫 번째 부분을 **검증 데이터**로 사용하고, 나머지 k-1개 부분을 **훈련 데이터**로 사용
  - 두 번째 반복에서는 두 번째 부분을 **검증 데이터**로 사용하고, 나머지 k-1개 부분을 **훈련 데이터**로 사용
  - 이 과정을 **k번 반복**합니다. 각 번마다 **검증 데이터**가 바뀌고, **훈련 데이터**는 그에 맞춰 바뀝니다.
  - **성능 평가**
    - 각 반복에서 모델의 성능을 평가한 후, **k번의 성능 평가**를 평균 내어 최종 성능을 계산
    - 이렇게 함으로써 데이터의 **모든 부분**이 검증 데이터로 사용되어 모델의 **일반화 능력**을 평가 가능
- 해결책 2: **하이퍼파라미터 튜닝**

### **Hyperopt**를 사용해 **XGBoost**라는 모델의 **최고 성능** 찾기!

- **Hyperopt**
  - **최적화** 도구
  - 모델의 **하이퍼파라미터**를 **최고로 맞추는** 방법을 찾아줌
- 예를 들어, **XGBoost**라는 모델에서 **어떤 설정이 가장 좋은지** 찾는 거임
  - 예: **25번**의 **시도**를 하면서 여러 설정을 시도해보고, 가장 성능이 좋은 설정을 찾는 거임
- **Hyperopt가 사용하는 기법**
  - **5-겹 교차 검증 (5-fold cross-validation)**
  - **25번**의 **시도**
  - **SHAP 분석**

### **샘플링 방법에 따른 신뢰 구간 차이**

- **샘플링 방법**에 따라 **신뢰 구간**이 다르게 나타날 수 있다.
- 복원 샘플링은 **tI**와 **cI**에 대한 **95% 신뢰 구간**을 더 정확하게 추정할 수 있다.
  - **비복원 샘플링**에서 **10:90** 비율로 훈련/테스트 데이터셋을 나눈 결과, **tI**와 **cI**의 **기준 진리**와 매우 차이가 나며, 신뢰 구간이 매우 넓음
  - **비복원 샘플링**에서 **90:10** 비율로 데이터를 나누었을 때, 신뢰 구간이 지나치게 좁고 비현실적인 결과를 보임
  - **복원 샘플링**을 사용한 결과가 **기준 진리**에 더 근접했으며, **신뢰 구간**도 더 현실적인 범위에 포함됨
- 즉, **복원 샘플링**을 써야 함

### **부트스트랩을 이용한 SHAP 값 추정**

- **부트스트랩 샘플링**을 사용하여 **SHAP 값**에 대한 **95% 신뢰 구간**을 추정하면 **불확실성**을 더 정확하게 추정 가능
  - **부트스트랩 샘플링**: 데이터를 **복원하여 반복적으로 샘플을 뽑는** 방법
    - 예: 데이터셋 [1, 2, 3, 4, 5] → 부트스트랩 샘플링 예시 [3, 1, 5, 5, 2]
- **부트스트랩 의존도 플롯**은 **설명 변수**와 **반응 변수** 간의 **비선형적 함수적 관계**를 시각적으로 보여줌
  - 각각의 **SHAP 값**에 대한 **신뢰 구간**도 함께 표현됨
- **XGBoost 모델**은 **비선형 E-R 관계**와 **교란 관계**를 잘 추정 가능 → **정확한 예측**
- **유도 모델**과 **유지 모델**에서의 **SHAP 의존도 플롯 → 불확실성** 측정 가능

### ML 모델의 장점과 한계

- **비선형 관계**가 있을 때 매우 잘 작동
- **E-R 분석**에 **ML 모델**과 **SHAP 값**을 사용하는 방법은 아직 초기 단계 (잠재적 문제점 우려)
  - **SHAP 분석**은 **out-of-sample 데이터**에서만 수행해야 함
  - **하이퍼파라미터 튜닝**을 통해 **모델 신뢰성**을 확인해야 함
  - **신뢰 구간**을 **복원 샘플링**을 통해 **현실적으로 추정**해야 함

---

## Machine Learning for Exposure-Response Analysis:

Methodological Considerations and Confirmation of Their
Importance via Computational Experimentations (Appendix 정리/요약)

### 부록: 각 파트의 핵심 목적

- **부록 A1**: 데이터 생성 과정을 설명 (실험의 신뢰성에 대한 설명)
- **부록 A2~A4**: 변수 정의 및 마진 효과 계산 방법을 통해 모델 성능을 검증하는 방법

### 참고: 연구에서 사용하는 주요 변수들의 정의

- **유도 단계 (Induction stage, I)**
  - **hI**: 건강 상태 (health status)
  - **xI1, xI2, xI3, xI4**: 공변량 (covariates)
    - 약물 효과에 영향을 미칠 수 있는 변수들
    - 나이, 성별 등
  - **rI**: 치료 무작위화 변수 (treatment randomization)
    - **rI = 1**이면 활성 치료군, **rI = 0**이면 위약군
  - **cI**: 유도 단계 시작 시점에서의 교란 변수 (confounding variable)
  - **tI**: 유도 단계에서의 약물 노출 (drug exposure)
- **유지 단계 (Maintenance stage, M)**
  - **hM**: 건강 상태
  - **xM1, xM2, xM3**: 공변량 (위와 마찬가지)
  - **rM**: 치료 무작위화 변수
  - **cM**: 유지 단계에서의 교란 변수
  - **tM**: 유지 단계에서의 약물 노출
- **y1, y2**: 이 변수들은 유도 단계와 유지 단계의 **이진 결과 변수**

### 부록 A1: 데이터 생성 과정

- **합성 데이터셋**을 어떻게 생성했는지에 대해 설명하고 있습니다.
  - **합성 데이터:** 실험적인 데이터로, 실제 데이터 대신 모델을 테스트하거나 분석할 때 사용

![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/29de5227-9524-4f28-844e-e4af0fbd3348/417108da-17bb-434d-a0bc-a4a6d16ef989/image.png)

- **다변량 정규 분포**에서 샘플링
  - **무작위 변수들**을 설정하고, 그 후 데이터 변환을 통해 **결과**를 생성
  - **HI**, **XI1**, **XI2**, **XI3**, **XI4**, **CI**, **CM**, **TI**, **TM** 등은 **무작위 변수**
- **변수 샘플링**
  - 각 환자에 대해 **9차원 벡터**가 샘플링
  - 벡터는 **다변량 정규 분포**에서 생성
  - 이 과정에서 일부 변수 간의 **상관관계**를 명시적으로 설정 가능
- **데이터 = 평균 벡터(μ) × 공분산 행렬(Σ)**
  - 평균 벡터(μ): 각 변수들의 **평균값**
  - 공분산 행렬(Σ): 변수들 간의 **상관 관계**
    - XI1과 XI2의 행렬 값이 -0.1 → 두 변수는 서로 약간의 부정적 관계
  - **무작위성**
    - 데이터를 생성할 때, **평균값 근처에서 무작위로 값을 뽑음**
    - 예를 들어, XI1의 평균값이 5라고 할 때, **샘플링된 값**은 4.8, 5.1, 5.3처럼 **조금씩 다른 값**이 나옴
    - 이때, 상관관계 때문에 XI2 값도 함께 영향을 받음
      - 예: XI1이 5.3으로 커지면, XI2는 약간 작아지는 값을 무작위로 뽑게 됨

### 부록 A2: 유도 단계의 정의

- **환자 데이터**를 생성하는 과정에서, **각 변수**가 어떻게 정의되는지 설명
  - **hI**: 건강 상태 (health status)
  - **xI1, xI2, xI3, xI4**: 공변량 (covariates), 즉 약물 효과에 영향을 미칠 수 있는 변수들
    - 예: **나이, 성별** 등
    - 이때, **xI = ln(XI)**와 \***\*같이 **로그\*\* 값 사용
      - 로그 변환 하는 이유
        - 대부분 **작은 값**에 몰려 있고, 몇몇 값은 **매우 큰 값**을 가질 때, 데이터가 **비대칭적**일 수 있으므로 **왜곡된 분포**를 더 **대칭적**으로 바꾸기 위함
  - **cI**: 유도 단계 시작 시점에서의 교란 변수 (confounding variable)
    - **cI**도 마찬가지로 **ln(CI)**로 **로그** 값 사용
  - **rI**: 치료 무작위화 변수 (treatment randomization)
    - **rI = 1**이면 활성 치료군, **rI = 0**이면 위약군
    - **rI = Bernoulli(0.5)**
      - **50% 확률**로 **치료군**과 **위약군**에 **랜덤으로 배정**된다는 뜻
  - **tI**: 유도 단계에서의 약물 노출 (drug exposure)
    - **tI**도 마찬가지로 **ln(TI)**로 **로그** 값 사용
- **유도 단계**에서 **y1**(0 or 1)은 어떻게 계산될까?
  - y1의 값은 잠재 변수 **hM**에 의해 결정
  - **hM**은 유도 단계 종료 시 환자의 **건강 상태**를 나타냄
  - **Sigmoid 함수**
    $$
    \sigma(x) = \frac{1}{1 + e^{-x}}
    $$
    - **hM** 값을 **긍정적인 결과의 확률**로 변환 → **환자가 긍정적인 결과를 얻을 확률**을 계산
- **Weibull 함수**
  $$
  W(x) = 10 \left( \frac{x}{3} \right)^2 e^{-\left( \frac{x}{3} \right)^3}
  $$
  - **x**는 **cI** 값이 들어갈 자리
  - 교란 변수 **cI**가 건강 상태 **hM**에 미치는 **비선형적 영향**을 나타내는 데 사용되는 함수
    - **Weibull 분포**는 **비선형적 관계**를 잘 표현 가능
    - **변수**가 일정 범위 내에서는 빠르게 변하다가, **다른 범위**에서는 **변화가 점차 감소**하는 형태를 모델링하기 적합
- **Hill 함수**
  $$
  Hill(x) = \frac{E_{max}}{1 + \left( \frac{2}{x} \right)^2}
  $$
  - **E_max**​는 **최대 반응값**을 나타내며, 여기서는 3으로 설정됨
  - **x**는 **약물 노출(tI)**
  - **Hill 계수**는 **반응의 경사도**를 결정
    - 여기서는 2로 설정되어 **약물 농도가 증가할수록 반응이 더 급격하게 증가**하도록 만듦
      - **k_m** = 2는 반응이 절반에 도달하는 약물 농도를 나타냄
        - 이 값은 x 값에 대한 포화가 시작되는 지점을 설정함
- **유도 단계**에서 **종속 변수**는 어떻게 정의될까?
  - 주어진 **hM** 값에 따라 환자의 **y1**이 결정되는 과정
  - **hM의 정의**
    $$
    hM := hI + W(cI) + Hill(tI | Emax = 3) - 1
    $$
    - **hI**: **초기 건강 상태**로, 유도 단계 이전에 설정된 값
    - **W(cI)**: **Weibull 함수**를 통해 정의된 **cI**(교란 변수)가 **hM**에 미치는 비선형적 영향을 나타냄
    - **Hill(tI∣Emax=3)**: **약물 노출 tI**가 **hM**에 미치는 **포화 효과**를 나타내는 **Hill 함수**
      - **E_max**는 최대 반응값 (여기서는 3으로 설정됨)
    - 마지막에 **1**을 빼는 이유는 **건강 상태의 지속적인 저하**를 나타냄
      - 이는 시간이 지남에 따라 **환자의 건강 상태가 나빠지는** 경향을 반영
  - **y1의 정의**
    $$
    y1 := \text{Bernoulli}(\sigma(hM))
    $$
    - **y1:** 환자가 유도 단계에서 **긍정적인 결과를 얻었는지 여부** (**0 or 1**)
    - **Bernoulli** 함수는 **σ(hM)** 확률을 기반으로 하여, **hM** 값에 따라 **긍정적인 결과**(1) 또는 **부정적인 결과**(0)를 생성
    - **σ(hM)**는 **Sigmoid 함수**를 통해 **hM** 값을 **확률**로 변환
      - 이 확률 값은 **환자가 긍정적인 결과를 얻을 확률**을 의미

### 부록 A3: 유지 단계에서의 정의

- **유지 단계**에서 사용되는 **데이터셋**의 생성 과정과 **변수 정의**에 대해 설명
  - 유지 단계는 **유도 단계에서 치료를 받은 환자들**에 대해서만 데이터를 생성
    - 이 연구에서는 943명
- **주요 변수들의 정의**

  - **건강 상태 (hM)**
    - **유도 단계에서의 건강 상태**가 그대로 **유지 단계의 시작 상태**
  - **xM1, xM2, xM3**

    - **유도 단계 변수 xI1, xI2, xI3**와 동일하지만, 여기에 **가우시안 잡음**(평균 0, 표준편차 0.01)을 추가하여 생성

      - 데이터에 **약간의 무작위성을 추가**하여 현실적인 변화를 모방하기 위함
        $$
        xM1 := xI1 + N(0, 0.01)\\
        xM2 := xI2 + N(0, 0.01)\\
        xM3 := xI3 + N(0, 0.01)
        $$

      $$

  - **cM, rM, tM**
    - **유도 단계의 변수**들인 **cI, rI, tI**와 비슷하게 정의
      - **cM**은 **유도 단계의 교란 변수 cI**와 비슷한 방식으로 설정
      - **rM**은 치료군(1)과 위약군(0)을 정의하는 **Bernoulli 분포**와 비슷한 방식으로 설정
      - **tM**은 **유도 단계의 약물 노출 변수 tI**와 유사하게 설정
        $$
        cM := \ln(CM)\\rM := \text{Bernoulli}(0.5)
        \\tM := \begin{cases}
        \ln(TM), & rM = 1 \\
        0, & \text{otherwise}
        \end{cases}
        $$

- **hF**와 **y2**의 수식적 표현
  - 두 변수의 정의
    - **hF**: 유지 단계에서의 건강 상태
    - **y2**: 유지 단계에서 환자가 긍정적인 결과(예: 치료 효과)를 얻었는지 여부를 나타내는 이진 변수 (0 or 1)
  - **hF**의 수식적 표현
    $$
    hF := hM + W(cM) + Hill(tM | Emax = 2) - 1
    $$
    - **유도 단계에서의 건강 상태**와 동일하게 설정
  - **y2**의 수식적 표현
    $$
    y2 := \text{Bernoulli}(\sigma(hF))
    $$
    - **유도 단계에서의 y1**과 동일하게 설정

### 부록 A4: 설명 변수의 마진 효과

- **기댓값을 기준으로 한 마진 효과**를 정의하고, 이를 구하는 방법을 설명함
- **마진 효과**
  - **어떤 변수의 변화가 결과에 미치는 영향**을 나타내는 개념
  - 하나의 변수가 변화할 때, 최종 결과에 얼마나 영향을 미치는지 나타냄
  - 예: 편미분, 기울기(계수) 등
- **인과 다이어그램**
  - **변수들 간의 의존 관계**를 시각적으로 나타내는 방법
  - 어떤 변수들이 결과 변수에 영향을 미치는지 이해하고, 분석에 포함하거나 제외해야 할 변수들을 결정할 수 있음
- 연구에서 사용되는 세 가지 **머신러닝 모델**
  - **유도 모델**
    - **유도 단계**의 변수들(xI1, xI2, xI3, xI4, cI)과 **약물 노출**(tI)을 사용하여 **y1**을 예측
  - **유지 모델**
    - **유지 단계**의 변수들(xM1, xM2, xM3, cM)과 **약물 노출**(tM)을 사용하여 **y2**를 예측
  - **유지-유도 모델**
    - **유도 단계** 변수들과 **약물 노출**(tI)을 사용하여 **y2**(**유지 단계에서의 결과**)를 예측
- **마진 효과의 계산**
  - **유도 모델**
    - 변수 **cI**가 **y1**에 미치는 영향을 **Weibull 함수**를 사용해 계산
    - 약물 노출 **tI**가 미치는 영향을 **Hill 함수**를 통해 계산
  - **유지 모델**
    - 비슷하게 변수들의 마진 효과를 계산
    - 변수들이 **hM**(유도 단계 종료 시 건강 상태)에 미치는 영향으로 **y2**를 예측
- **실제 마진 효과**와 **모델이 추정한 마진 효과** 비교하기
  - **실제 마진 효과**는 **기대값**을 기준으로 계산
    - **전체 데이터셋에서 변수들의 평균 마진 효과**를 계산한 값
  - 모델이 추정한 **SHAP 값**
    - 변수들이 **예상 값**에 대해 얼마나 영향을 미쳤는지를 나타내는 값
    - 이 값들을 비교하여 모델이 추정한 마진 효과가 **실제 마진 효과**와 얼마나 일치하는지 평가
  - 변수 **vi의 마진 효과**는 **Δvi**로 정의
    - 해당 변수에 대한 변화가 결과에 미친 영향을 나타냄
  - **기대값을 기준으로 한 마진 효과**는 **전체 환자들의 평균 마진 효과**를 빼서 구함
    $$
    \phi_{v_i} = \Delta v_i - \frac{1}{N} \sum_{j=1}^{N} \Delta v_j
    $$
    - 이 값을 통해 **각 변수의 영향**을 **기대값에 대해 상대적으로 계산**할 수 있음
